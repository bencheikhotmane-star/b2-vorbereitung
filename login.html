<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zugangscode eingeben</title>
  <style>
    body {
       font-family: sans-serif;
       display:flex;
       justify-content:center;
       align-items:center;
       height:100vh;
       background:#1b263b;
       color:#fff;
       margin:0;
    }
    form {
       background:#0d1b2a;
       padding:30px;
       border-radius:12px;
       text-align:center;
       box-shadow:0 8px 20px rgba(0,0,0,0.5);
      max-width: 340px;
      width: 100%;
    }
    input[type="text"] {
       padding:12px;
       width:200px;
       border-radius:6px;
       margin-bottom:15px;
       border:none;
       text-align:center;
       font-size:16px;
    }
    button {
       padding:12px 20px;
       border:none;
       border-radius:6px;
       background:#e63946;
       color:#fff;
       cursor:pointer;
       font-weight:bold;
       transition: all 0.3s ease;
     }
    button:hover:not(:disabled) { background:#d62828; transform: scale(1.05); }
    button:disabled { background: #555; cursor: not-allowed; }
    .error-message { margin-top:10px; color:#e63946; font-weight:bold; }
    .countdown { margin-top:5px; color:#a8dadc; font-weight:600; }
    /* Contact buttons */
    .contact-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .contact-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      color: white;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      font-size: 14px;
    }
    .contact-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.3);
    }
    .whatsapp { background: #25D366; }
    .telegram { background: #0088cc; }
    .contact-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
    }
  </style>
</head>
<body>
  <form id="loginForm" method="post" autocomplete="off">
    <h1>Zugangscode eingeben</h1>
    <label for="code" style="display:none;">Zugangscode</label>
    <input type="text" id="code" name="code" placeholder="Code eingeben" required autocomplete="off">
    <br>
    <button id="loginBtn" type="submit">Einloggen</button>
    
    <div id="errorMessage" class="error-message" style="display:none;"></div>
    
    <div class="contact-buttons">
      <a href="https://wa.me/+212619627707" target="_blank" rel="noopener noreferrer" class="contact-btn whatsapp">
        <svg viewBox="0 0 32 32"><path d="M16 .6C7.4.6.4 7.6.4 16.1c0 2.8.7 5.4 2 7.8L0 32l8.4-2.2c2.3 1.2 4.9 1.8 7.6 1.8 8.6 0 15.6-7 15.6-15.6S24.6.6 16 .6zm0 28.4c-2.3 0-4.6-.6-6.6-1.7l-.5-.3-5 .9.9-4.9-.3-.5c-1.2-2-1.8-4.3-1.8-6.6 0-7 5.7-12.6 12.6-12.6s12.6 5.7 12.6 12.6S23 29 16 29zm6.9-9.5c-.4-.2-2.3-1.1-2.6-1.3s-.6-.2-.9.2-1.1 1.3-1.3 1.5-.5.3-.9.1-1.8-.7-3.4-2.2c-1.2-1.1-2-2.5-2.2-2.9s0-.6.2-.8.4-.5.6-.8c.2-.3.3-.5.5-.9.2-.4.1-.6 0-.8s-.9-2.1-1.2-2.9c-.3-.8-.6-.7-.9-.7h-.8c-.3 0-.8.1-1.2.6s-1.6 1.5-1.6 3.7 1.6 4.3 1.8 4.6 3.1 4.7 7.6 6.6c4.5 1.8 4.5 1.2 5.3 1.1.8-.1 2.3-1 2.6-1.9.3-.9.3-1.6.2-1.8-.1-.2-.3-.3-.7-.5z"/></svg>
        WhatsApp
      </a>
      <a href="https://t.me/pruefvorbnes" target="_blank" rel="noopener noreferrer" class="contact-btn telegram">
        <svg viewBox="0 0 24 24"><path d="M9.999 15.5l-.4 5.5c.6 0 .9-.3 1.2-.6l2.9-2.7 6 4.3c1.1.6 1.9.3 2.2-1l4.1-19.5c.4-1.6-.6-2.2-1.7-1.8L1.5 9.7c-1.6.6-1.6 1.6-.3 2l5.7 1.8L19 5c.8-.5 1.5-.2.9.3L9.999 15.5z"/></svg>
        Telegram
      </a>
    </div>
  </form>

  <script>
    // *********************************************************************************
    // ⚠️ مهم جداً: استبدل هذا الرابط برابط خدمة الـ Backend API الحقيقي الذي حصلت عليه من Render
    // *********************************************************************************
    const BACKEND_URL = "https://b2-api-checker.onrender.com"; 
    const API_ENDPOINT = BACKEND_URL + "/api/verify_code"; 
    const REDIRECT_PAGE = "index.html"; 
    
    // مفتاح تخزين تاريخ انتهاء الصلاحية
    const ACCESS_KEY = 'site_access_token'; 
    
    const loginForm = document.getElementById('loginForm');
    const codeInput = document.getElementById('code');
    const errorMessage = document.getElementById('errorMessage');

    // 1. وظيفة التحقق من الوصول السابق والصلاحية
    function checkAccess() {
        const storedExpiration = localStorage.getItem(ACCESS_KEY);
        const currentTime = new Date().getTime();

        // إذا كان هناك توقيت انتهاء صلاحية مخزن ولم ينته بعد
        if (storedExpiration && currentTime < storedExpiration) {
            // التوجيه مباشرة إلى الصفحة الرئيسية
            window.location.replace(REDIRECT_PAGE);
            return true;
        }
        // إذا انتهت الصلاحية، قم بإزالة التوكن
        if (storedExpiration && currentTime >= storedExpiration) {
             localStorage.removeItem(ACCESS_KEY);
        }
        return false;
    }

    // 2. وظيفة معالجة إرسال الكود
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault(); 
        errorMessage.style.display = 'none';
        
        const enteredCode = codeInput.value.trim();
        if (enteredCode === "") {
            errorMessage.innerHTML = "الرجاء إدخال كود الوصول.";
            errorMessage.style.display = 'block';
            return;
        }

        try {
            // تعطيل الزر أثناء إرسال الطلب
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = "جاري التحقق...";
            
            // إرسال الكود إلى السيرفر (app.py)
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: enteredCode })
            });

            const result = await response.json();
            
            // إعادة تفعيل الزر
            loginBtn.disabled = false;
            loginBtn.innerHTML = "Einloggen";

            if (response.ok && result.status === 'success') {
                // الكود صحيح!
                const validUntil = result.valid_until; 
                localStorage.setItem(ACCESS_KEY, validUntil); 
                
                // التوجيه إلى الصفحة الرئيسية
                window.location.replace(REDIRECT_PAGE); 
            } else {
                // الكود غير صالح أو منتهي الصلاحية
                errorMessage.innerHTML = result.message || "فشل التحقق. الكود غير صالح.";
                errorMessage.style.display = 'block';
                codeInput.value = ''; 
            }

        } catch (error) {
            // هذا الخطأ يحدث إذا فشل الاتصال بالسيرفر
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = false;
            loginBtn.innerHTML = "Einloggen";
            
            errorMessage.innerHTML = "حدث خطأ في الاتصال بالخادم. تأكد من نشر خدمة الـ API.";
            errorMessage.style.display = 'block';
            console.error('Fetch Error:', error);
        }
    });

    // تنفيذ التحقق عند تحميل الصفحة
    checkAccess();
  </script>
</body>
</html>
